<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mxeaez Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #0b0b0d;
        --panel: #121316;
        --muted: #9aa0a6;
        --text: #f1f5f9;
        --border: #26272b;
        --green: #22c55e;
        --blue: #60a5fa;
        --red: #ef4444;
        --amber: #f59e0b;
        --radius: 14px;
        --pad: 14px;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --font: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: var(--font);
      }
      .app {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 16px;
        padding: 16px;
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .head {
        padding: 12px var(--pad);
        border-bottom: 1px solid var(--border);
        font-weight: 600;
      }
      .body {
        padding: var(--pad);
      }
      .row {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .btn {
        background: #1f2937;
        border: 1px solid var(--border);
        color: #fff;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      .btn:hover {
        background: #263142;
      }
      .btn.red {
        background: #3b1e1f;
        border-color: #4a2324;
      }
      .btn.red:hover {
        background: #4a2324;
      }
      .btn.green {
        background: #1f2f24;
        border-color: #234a32;
      }
      .btn.green:hover {
        background: #234a32;
      }
      .input,
      select {
        background: #0f1115;
        color: #fff;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 10px;
      }
      .list {
        max-height: 70vh;
        overflow: auto;
      }
      .redeem {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-bottom: 1px solid var(--border);
      }
      .redeem:hover {
        background: #14161a;
      }
      .av {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: #222 center/cover no-repeat;
        border: 1px solid var(--border);
      }
      .meta {
        font-size: 12px;
        color: var(--muted);
      }
      .pill {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid var(--border);
        margin-left: 6px;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .mt {
        margin-top: 10px;
      }
      .muted {
        color: var(--muted);
      }
      .hidden {
        display: none;
      }
      .login-wrap {
        min-height: 100vh;
        display: grid;
        place-items: center;
      }
      .foot {
        padding: 10px var(--pad);
        border-top: 1px solid var(--border);
        font-size: 12px;
        color: var(--muted);
      }
      @media (max-width: 900px) {
        .app {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div id="loginView" class="login-wrap">
      <div class="card" style="width: min(520px, 92vw); padding: 20px">
        <div class="head">Admin Sign In</div>
        <div class="body">
          <div class="row" style="margin-bottom: 10px">
            <div style="width: 110px; color: var(--muted)">Username</div>
            <input
              id="adminUser"
              class="input"
              placeholder="Username"
              style="flex: 1"
            />
          </div>
          <div class="row" style="margin-bottom: 10px">
            <div style="width: 110px; color: var(--muted)">Admin Key</div>
            <input
              id="adminKey"
              class="input"
              type="password"
              placeholder="••••••••••"
              style="flex: 1"
            />
          </div>
          <div class="row" style="justify-content: flex-end; gap: 8px">
            <button class="btn" onclick="clearCreds()">Clear</button>
            <button class="btn" onclick="signIn()">Sign In</button>
          </div>
          <div
            id="loginError"
            style="display: none; color: #ef4444; margin-top: 8px"
          ></div>
        </div>
      </div>
    </div>

    <div id="appView" class="app hidden">
      <div class="card" style="grid-column: 1 / -1; padding: 10px 14px">
        <div class="row" style="justify-content: space-between">
          <div class="muted">Shop Admin</div>
          <div class="row" style="gap: 8px">
            <button class="btn" onclick="refresh()">Refresh</button>
            <button class="btn" onclick="signOut()">Sign out</button>
          </div>
        </div>
      </div>

      <!-- Left: Redemption History -->
      <div class="card">
        <div class="head">Redemptions</div>
        <div class="body">
          <div id="list" class="list"></div>
        </div>
        <div class="foot">
          Click a redemption to refund points + return item.
        </div>
      </div>

      <!-- Right: Admin tools -->
      <div class="card">
        <div class="head">Admin Tools</div>
        <div class="body">
          <div class="grid2">
            <div>
              <div class="muted">Grant Item to User</div>
              <input
                id="grantLogin"
                class="input mt"
                placeholder="Twitch login (lowercase)"
              />
              <div class="row mt">
                <select id="grantItem" class="input"></select>
                <input
                  id="grantQty"
                  type="number"
                  min="1"
                  value="1"
                  class="input"
                  style="width: 80px"
                />
              </div>
              <button class="btn green mt" onclick="grantItemToLogin()">
                Grant
              </button>
              <div id="grantInfo" class="muted mt"></div>
            </div>

            <div>
              <div class="muted">Grant Item to Active Viewers</div>
              <div class="row mt">
                <select id="grantAllItem" class="input"></select>
                <input
                  id="grantAllQty"
                  type="number"
                  min="1"
                  value="1"
                  class="input"
                  style="width: 80px"
                />
                <input
                  id="sinceMinItems"
                  type="number"
                  min="1"
                  value="5"
                  class="input"
                  style="width: 100px"
                  title="minutes"
                />
              </div>
              <button class="btn green mt" onclick="grantItemToAll()">
                Grant to Active
              </button>
            </div>
          </div>
        </div>
        <div class="foot">
          Presence = viewers who opened the panel in last N minutes.
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      function headers() {
        const u = localStorage.getItem("adm.user") || "";
        const k = localStorage.getItem("adm.key") || "";
        return {
          "Content-Type": "application/json",
          "x-admin-user": u,
          "x-admin-key": k,
        };
      }

      function clearCreds() {
        localStorage.removeItem("adm.user");
        localStorage.removeItem("adm.key");
        const u = $("adminUser");
        if (u) u.value = "";
        const k = $("adminKey");
        if (k) k.value = "";
      }

      async function refresh() {
        const r = await fetch(`/admin/redemptions?limit=50`, {
          headers: headers(),
        });
        if (!r.ok) {
          if (r.status === 401 || r.status === 403) {
            signOut();
            return;
          }
          alert(await r.text());
          return;
        }
        const rows = await r.json();
        renderList(rows);
      }

      function showLogin() {
        console.log("[admin] showLogin");
        const lv = $("loginView");
        const av = $("appView");
        if (lv) {
          lv.classList.remove("hidden");
          lv.style.display = "";
        }
        if (av) {
          av.classList.add("hidden");
          av.style.display = "none";
        }
        const e = $("loginError");
        if (e) {
          e.textContent = "";
          e.style.display = "none";
        }
      }

      function showApp(username) {
        console.log("[admin] showApp for", username);
        const lv = $("loginView");
        const av = $("appView");
        if (lv) {
          lv.classList.add("hidden");
          lv.style.display = "none";
        }
        if (av) {
          av.classList.remove("hidden");
          av.style.display = "";
        }
      }

      async function probeAuth() {
        try {
          // Probe the same guarded endpoint your UI uses
          const r = await fetch("/admin/redemptions?limit=1", {
            headers: headers(),
          });
          console.log("[admin] probeAuth status", r.status);
          return r.ok;
        } catch (e) {
          console.warn("[admin] probeAuth failed", e);
          return false;
        }
      }

      async function signIn() {
        const err = $("loginError");
        if (err) {
          err.textContent = "";
          err.style.display = "none";
        }

        const user = ($("adminUser")?.value || "").trim().toLowerCase();
        const key = ($("adminKey")?.value || "").trim();

        if (!user || !key) {
          if (err) {
            err.textContent = "Enter both username and admin key.";
            err.style.display = "block";
          }
          return;
        }

        // Save creds that headers() uses
        localStorage.setItem("adm.user", user);
        localStorage.setItem("adm.key", key);
        console.log("[admin] saved creds", { user });

        const ok = await probeAuth();
        if (!ok) {
          clearCreds();
          if (err) {
            err.textContent = "Invalid credentials or not whitelisted.";
            err.style.display = "block";
          }
          return;
        }

        // Success: show app
        showApp(user);

        // Load data with guards so UI still flips even if these throw
        try {
          if (typeof loadItems === "function") {
            console.log("[admin] loadItems()");
            await loadItems();
          }
        } catch (e) {
          console.warn("[admin] loadItems failed", e);
        }

        try {
          if (typeof refresh === "function") {
            console.log("[admin] refresh()");
            await refresh();
          }
        } catch (e) {
          console.warn("[admin] refresh failed", e);
        }
      }

      function signOut() {
        clearCreds();
        showLogin();
      }

      function renderList(rows) {
        const el = $("list");
        el.innerHTML = "";
        for (const r of rows) {
          const d = new Date(r.createdAt);
          const div = document.createElement("div");
          div.className = "redeem";
          div.innerHTML = `
          <div class="av" style="background-image:url('${
            (r.viewer && r.viewer.avatar) || ""
          }')"></div>
          <div style="flex:1">
            <div><b>${escapeHtml(
              (r.viewer && (r.viewer.login || r.viewer.userId)) || "Someone"
            )}</b> redeemed <b>${escapeHtml(r.itemName)}</b></div>
            <div class="meta">${d.toLocaleString()}</div>
          </div>
          <button class="btn red" title="Refund this redemption">Refund</button>
        `;
          div.querySelector("button").onclick = () => refund(r.id);
          el.appendChild(div);
        }
      }

      async function refund(redemptionId) {
        if (!confirm("Refund this redemption?")) return;
        const r = await fetch(`/admin/refund`, {
          method: "POST",
          headers: headers(),
          body: JSON.stringify({
            redemption_id: redemptionId,
          }),
        });
        if (!r.ok) return alert(await r.text());
        refresh();
      }

      // --- Grant item to a single user by login: resolve to opaqueUserId, then grant
      async function grantItemToLogin() {
        const login = $("grantLogin").value.trim().toLowerCase();
        const itemId = $("grantItem").value;
        const qty = Number($("grantQty").value || 1);
        const info = $("grantInfo");
        info.textContent = "Resolving user…";

        const userRes = await fetch(
          `/admin/users/search?q=${encodeURIComponent(login)}`,
          { headers: headers() }
        );

        const users = await userRes.json();
        const u = users && users[0];
        if (!u) {
          info.textContent = "User not found.";
          return;
        }
        if (!u.opaqueUserId) {
          info.textContent =
            "User has not opened the panel recently (no opaque id). Ask them to open the panel once.";
          return;
        }

        const r = await fetch(`/admin/grant-item`, {
          method: "POST",
          headers: headers(),
          body: JSON.stringify({
            itemId,
            qty,
            opaqueUserId: u.opaqueUserId,
          }),
        });
        if (!r.ok) {
          info.textContent = "Grant failed: " + (await r.text());
          return;
        }
        info.textContent = `Granted ${qty} × ${itemId} to ${u.login}`;
      }

      async function grantItemToAll() {
        const itemId = $("grantAllItem").value;
        const qty = Number($("grantAllQty").value || 1);
        const minutes = Number($("sinceMinItems").value || 5);
        const r = await fetch(`/admin/grant-item-all`, {
          method: "POST",
          headers: headers(),
          body: JSON.stringify({
            itemId,
            qty,
            sinceMinutes: minutes,
          }),
        });
        const j = await r.json();
        if (!r.ok) return alert(j.error || "Failed");
        alert(
          `Granted ${qty} × ${itemId} to ${j.viewers} active viewers (wrote ${j.granted} items)`
        );
      }

      function escapeHtml(s) {
        return String(s).replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      async function loadItems() {
        // need admin headers for this one
        const r = await fetch("/admin/items", { headers: headers() });
        if (!r.ok) {
          console.error("Failed to load admin items", await r.text());
          return;
        }
        const { items, grantOnlyIds } = await r.json();
        const grantOnly = new Set(grantOnlyIds || []);

        // sort by rarity then name (optional, looks nicer)
        const order = { Common: 0, Rare: 1, Unique: 2, Legendary: 3 };
        items.sort((a, b) => {
          const ra = order[a.rarity] ?? 99,
            rb = order[b.rarity] ?? 99;
          if (ra !== rb) return ra - rb;
          return a.name.localeCompare(b.name);
        });

        for (const id of ["grantItem", "grantAllItem"]) {
          const sel = document.getElementById(id);
          if (!sel) continue;
          sel.innerHTML = "";
          for (const it of items) {
            const opt = document.createElement("option");
            const tag = grantOnly.has(it.id) ? " • grant-only" : "";
            opt.value = it.id;
            opt.textContent = `${it.name} (${it.rarity}${tag})`;
            sel.appendChild(opt);
          }
        }
      }

      (async function boot() {
        try {
          const u = localStorage.getItem("adm.user");
          const k = localStorage.getItem("adm.key");
          if (u && k) {
            console.log("[admin] found saved creds for", u);
            if (await probeAuth()) {
              showApp(u);
              try {
                if (typeof loadItems === "function") await loadItems();
              } catch {}
              try {
                if (typeof refresh === "function") await refresh();
              } catch {}
              return;
            }
          }
          clearCreds();
          showLogin();
        } catch (e) {
          console.warn("[admin] boot error", e);
          showLogin();
        }
      })();
    </script>
  </body>
</html>
